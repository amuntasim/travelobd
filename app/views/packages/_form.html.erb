<%= content_for :js_css_include do %>
    <%= javascript_include_tag 'jquery.validate' %>
    <%= stylesheet_link_tag 'jquery-ui', 'autocomplete' %>
<% end %>

<%= form_for(@package, :html => {:multipart => true, :id=> 'package_form'}) do |f| %>
    <% @builder = f %>
    <% if @package.errors.any? %>
        <div id="error_explanation">
          <h2><%= pluralize(@package.errors.count, "error") %> prohibited this package from being saved:</h2>

          <ul>
            <% @package.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
    <% end %>

    <div class="item_form_row">
      <label> Category<span>*</span>:</label>
      <%= f.select :category_id, Package::CATEGORIES, :prompt=> 'Select Category' %>
    </div>


    <div class="item_form_row">
      <label> Tittle<span>*</span>:</label>
      <%= f.text_field :title %>
    </div>


    <div class="item_form_row">
      <label> Short Description<span>*</span>:</label>
      <%= f.text_field :short_description %>
    </div>


    <div class="item_form_row">
      <label> Asking Price<span>*</span>:</label>
      <%= f.text_field :price %>    <%= f.check_box :price_per_person %> per Person
    </div>

    <div class="item_form_row">
      <label> Price Includes:</label>
      <%= f.text_area :price_includes, :style => 'height:40px' %>
    </div>

    <div class="item_form_row">
      <label> Price Excludes:</label>
      <%= f.text_area :price_excludes, :style => 'height:40px' %>
    </div>

    <div class="item_form_row">
      <label> Company:</label>
      <%= f.text_field :company %>
    </div>

    <div class="item_form_row">
      <label> Phone#<span>*</span>:</label>
      <%= f.text_field :phone %>
    </div>


    <div class="item_form_row">
      <label>
        Start date:
      </label>
      <%= f.text_field :start_date %>
    </div>
    <div class="item_form_row">
      <label>
        End date:
      </label>
      <%= f.text_field :end_date %>
    </div>
    <div class="item_form_row">
      <label>
        Discount:
      </label>
      <%= f.text_field :discount %>
    </div>


    <div class="item_form_row">
      <label>
        Discount till:
      </label>
      <%= f.text_field :discount_till %>
    </div>

    <div class="item_form_row">
      <label> Destinations:</label>

      <div class="f_edit_row photo_box">
        <% for district in District.actives %>
            <div class="spot_in_package district_in_package">
              <%= check_box_tag "package[destination_ids][]", district.id, @package.destinations.include?(district), :id => dom_id(district) %>

              <label for="<%= dom_id(district) %>"><%= district.name %></label>
            </div>
        <% end %>
      </div>


    </div>
    <div class="item_form_row">
      <label> Spots:</label>

      <div class="f_edit_row photo_box">
        <% for spot in Spot.actives.includes(:district) %>
            <div class="spot_in_package spot_of_district_<%= spot.district_id %>">
              <%= check_box_tag "package[spot_ids][]", spot.id, @package.spots.include?(spot), :prev_checked => @package.spots.include?(spot), :id => dom_id(spot) %>

              <label for="<%= dom_id(spot) %>"><%= spot.name %></label>
            </div>
        <% end %>
      </div>
    </div>

    <div class="item_form_row">
      <label> Describe Your Package :</label>
      <%= f.text_area :description, :rows => 20, :cols => 80 %>
    </div>


    <div class="item_form_row">
      <label> Image:</label>

      <div class="f_edit_row photo_box">
        <!-- <h3>Images <span style="font-size: 11px;"><%#= package_photo_number_str(@package) %></span></h3>-->
        <div class="edit_img_row">

          <% unless @package.new_record? %>
              <%= render :partial => 'existing_photo', :collection => @package.assets %>
          <% end %>

          <div id="package_photos">
            <%= render :partial => 'photo', :locals => {:form => f, :photo => @package.assets.new} if @package.new_record? %>
          </div>

        </div>
        <%= link_to '+Ad More', 'javascript:void(0)', :class=>'adMore addMoreImage' %>
        <%#= add_object_link("+Add More", f, @package.assets.new, "photo", "#ad_images", 'adMore addMoreImage') %>
      </div>
      <% if @package.featured? %>
          <div class="tubeRow">
            <div class="tube_input_area">
              <label>You Tube Video Link</label>

              <div id="package_videos">
                <%= render :partial => 'video', :collection => @package.videos, :locals => {:form => f} %>
              </div>
              <%= link_to '+Ad More', 'javascript:void(0)', :class=>'adMore adMoreVideo' %>
            </div>

          </div>
      <% end %>
    </div>

    <div class="item_form_row">
      <label> Event Detail:</label>

      <div class="f_edit_row photo_box" style="width:705px;">


        <div id="package_events" class="package_events">

          <% unless @package.new_record? %>
              <%= render :partial => 'event', :collection => @package.events, :locals => {:form => f} %>
          <% end %>
          <%= render :partial => 'event', :locals => {:form => f, :event => @package.events.new} if @package.new_record? || @package.events.size == 0 %>
        </div>

        <%= link_to '+Ad More', 'javascript:void(0)', :class=>'adMore addMoreEvent' %>
      </div>

    </div>

    <div class="item_form_row">
      <label> Itineraries:</label>

      <div class="f_edit_row photo_box" style="width:705px;">


        <div id="package_itineraries" class="package_events">

          <% unless @package.new_record? %>
              <%= render :partial => 'itinerary', :collection => @package.itineraries, :locals => {:form => f} %>
          <% end %>
          <%= render :partial => 'itinerary', :locals => {:form => f, :itinerary => @package.itineraries.new} if @package.new_record? || @package.itineraries.size == 0 %>
        </div>

        <%= link_to '+Ad More', 'javascript:void(0)', :class=>'adMore addMoreItinerary' %>
      </div>

    </div>


    <div class="item_form_row">
      <label> Contacts:</label>

      <div class="f_edit_row photo_box" style="width:705px;">


        <div id="package_contacts" class="package_events">

          <% unless @package.new_record? %>
              <%= render :partial => 'contact', :collection => @package.contacts, :locals => {:form => f} %>
          <% end %>
          <%= render :partial => 'contact', :locals => {:form => f, :contact => @package.contacts.new} if @package.new_record? || @package.contacts.size == 0 %>
        </div>

        <%= link_to '+Ad More', 'javascript:void(0)', :class=>'adMore addMoreContact' %>
      </div>

    </div>

    <div class="item_form_row">
      <label> Conditions:</label>

      <div class="f_edit_row photo_box" style="width:705px;">


        <div id="package_conditions" class="package_events">

          <% unless @package.new_record? %>
              <%= render :partial => 'condition', :collection => @package.conditions, :locals => {:form => f} %>
          <% end %>
          <%= render :partial => 'condition', :locals => {:form => f, :condition => @package.conditions.new} if @package.new_record? || @package.conditions.size == 0 %>
        </div>

        <%= link_to '+Ad More', 'javascript:void(0)', :class=>'adMore addMoreCondition' %>
      </div>

    </div>



    <div class="submit_btn">
      <%= f.submit :class => 'search_button' %>
      <span class="search_button_right"> </span>
    </div>


<% end %>
<div style="display: none">
  <div id="new_video_html">
    <%= render(:partial => 'video', :locals => {:form => @builder}, :object => @package.videos.new) %>
  </div>


  <div id="new_photo_html">
    <%= render(:partial => 'photo', :locals => {:form => @builder}, :object => @package.assets.new) %>
  </div>

  <div id="new_event_html">
    <%= render(:partial => 'event', :locals => {:form => @builder}, :object => @package.events.new) %>
  </div>

  <div id="new_itinerary_html">
    <%= render(:partial => 'itinerary', :locals => {:form => @builder}, :object => @package.itineraries.new) %>
  </div>

  <div id="new_contact_html">
    <%= render(:partial => 'contact', :locals => {:form => @builder}, :object => @package.contacts.new) %>
  </div>

  <div id="new_condition_html">
    <%= render(:partial => 'condition', :locals => {:form => @builder}, :object => @package.conditions.new) %>
  </div>


</div>

<style type="text/css">
    .package_contact_address {
        float: left;
        width: 425px;
    }

    .package_contact_address textarea {
        background: none;
        border: 1px solid #ccc;
        -moz-border-radius: 5px;
        border-radius: 5px;
        -webkit-border-radius: 5px;
        float: left;
        height: 60px;
        padding-top: 5px;
        width: 400px;
    }

    .event {
        margin-bottom: 15px;
    }
</style>
<script type="text/javascript">
    var allowed_images = 10;
    var allowed_videos = 0;
    <%if @package.featured?%>
    allowed_images =  <%=@package_settings['featured_package_photos'] || 15 %>;
    allowed_videos =  <%=@package_settings['featured_package_videos'] || 2 %>;
    <%end%>


    $.fn.checkUncheckSpot = function() {
        if (!$(this).attr('checked')) {
            $('.spot_of_district_' + $(this).attr('value')).children('input[type="checkbox"]').each(function() {
                $(this).removeAttr('checked');
            });
            $('.spot_of_district_' + $(this).attr('value')).hide();
        }
        else {
            $('.spot_of_district_' + $(this).attr('value')).show();
            $('.spot_of_district_' + $(this).attr('value')).children('input[type="checkbox"]').each(function() {
                if ($(this).attr('prev_checked') == 'true')
                    $(this).attr('checked', 'checked');
            });
        }

    },

            $.fn.handleDistrictSelection = function() {
                $(".district_in_package input[type='checkbox']").change(function () {
                    $(this).checkUncheckSpot();
                });

            },

            $.fn.removePEvent = function() {
                $(this).parents('.event').remove();
            },
            $.fn.removePItinerary = function() {
                $(this).parents('.itinerary').remove();
            },
            $.fn.removePContact = function() {
                $(this).parents('.contact').remove();
            },

            $.fn.removePDestination = function() {
                $(this).parents('.destination').remove();
            },
            $.fn.removePConditions = function() {
                $(this).parents('.condition').remove();
            },


            $(document).ready(function() {

                $('a.addMoreContact').click(function() {
                    var new_object_id = new Date().getTime();
                    var html = $($('#new_contact_html').html().replace(/index_to_replace_with_js/g, new_object_id)).hide();
                    html.appendTo($('#package_contacts')).slideDown('slow');
                    $('span.removeContactField').click(function() {
                        $(this).removePContact();
                    });

                    $('span.removeContactField').click(function() {
                        $(this).removePContact();
                    });
                });

                $('span.removeContactField').click(function() {
                    $(this).removePContact();
                });

                $('a.addMoreCondition').click(function() {
                    var new_object_id = new Date().getTime();
                    var html = $($('#new_condition_html').html().replace(/index_to_replace_with_js/g, new_object_id)).hide();
                    html.appendTo($('#package_conditions')).slideDown('slow');
                    $('span.removeConditionField').click(function() {
                        $(this).removePCondition();
                    });

                    $('span.removeConditionField').click(function() {
                        $(this).removePCondition();
                    });
                });

                $('span.removeConditionField').click(function() {
                    $(this).removePCondition();
                });


                $('a.addMoreDestination').click(function() {
                    var new_object_id = new Date().getTime();
                    var html = $($('#new_destination_html').html().replace(/index_to_replace_with_js/g, new_object_id)).hide();
                    html.appendTo($('#package_destinations')).slideDown('slow');
                    $('span.removeDestinationField').click(function() {
                        $(this).removePDestination();
                    });

                    $('span.removeDestinationField').click(function() {
                        $(this).removePDestination();
                    });
                });

                $('span.removeDestinationField').click(function() {
                    $(this).removePDestination();
                });

                $('a.addMoreEvent').click(function() {
                    var new_object_id = new Date().getTime();
                    var html = $($('#new_event_html').html().replace(/index_to_replace_with_js/g, new_object_id)).hide();
                    html.appendTo($('#package_events')).slideDown('slow');
                    $('span.removeEventField').click(function() {
                        $(this).removePEvent();
                    });

                    $('span.removeEventField').click(function() {
                        $(this).removePEvent();
                    });
                });

                $('span.removeEventField').click(function() {
                    $(this).removePEvent();
                });


                $('a.addMoreItinerary').click(function() {
                    var new_object_id = new Date().getTime();
                    var html = $($('#new_itinerary_html').html().replace(/index_to_replace_with_js/g, new_object_id)).hide();
                    html.appendTo($('#package_itineraries')).slideDown('slow');
                    $('span.removeItineraryField').click(function() {
                        $(this).removePItinerary();
                    });

                    $('span.removeItineraryField').click(function() {
                        $(this).removePItinerary();
                    });
                });

                $('span.removeItineraryField').click(function() {
                    $(this).removePItinerary();
                });


                $('span.removeImageField').click(function() {
                    $(this).parents('.photo').remove();
                });


                $('a.adMoreVideo').click(function() {
                    if ($($('a.removeVideo')).length > allowed_videos) {
                        alert('Maximum allowed ' + allowed_videos);
                        return false;
                    }
                    else {
                        var new_object_id = new Date().getTime();
                        var html = $($('#new_video_html').html().replace(/index_to_replace_with_js/g, new_object_id)).hide();
                        html.appendTo($('#package_videos')).slideDown('slow');
                        $('a.removeVideo').click(function() {
                            $(this).parents('.video').remove();
                        });
                    }

                });

                $('a.removeVideo').click(function() {
                    $(this).parents('.video').remove();
                });


                $("#package_form").validate({
                    errorPlacement: function(error, element) {
                        error.remove();
                    },


                    rules: {
                        'package[category_id]': "required",
                        'package[title]' : "required",
                        'package[price]': "required"
                        //package_package_name: "required",
                        //package_short_description: "required"

                    },
                    messages: {
                        comment: "Please enter a comment."
                    }
                });

                $('#package_discount_till, #package_start_date, #package_end_date').datepicker({
                    changeMonth: true,
                    changeYear: true
                });
                $(this).addMorePhoto('package_photos', allowed_images);
                $(this).deleteAsset('packages');
                $(this).makeMainPhoto('packages');
                $(this).handleDistrictSelection();

                $(".district_in_package input[type='checkbox']").each(function () {
                    $(this).checkUncheckSpot();
                });

            });


</script>
