<%= content_for :js_css_include do %>
    <%= javascript_include_tag 'jquery.validate', 'thickbox' %>
    <%= stylesheet_link_tag 'jquery-ui', 'autocomplete', 'thickbox' %>
<% end %>

<%= form_for(@tour_operator, :html => {:multipart => true, :id=> 'tour_operator_form'}) do |f| %>
    <% @builder = f %>
    <% if @tour_operator.errors.any? %>
        <div id="error_explanation">
          <h2><%= pluralize(@tour_operator.errors.count, "error") %> prohibited this tour_operator from being
            saved:</h2>

          <ul>
            <% @tour_operator.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
    <% end %>

    <div class="item_form_row">
      <label> Category<span>*</span>:</label>
      <%= f.select :category_id, TourOperator::CATEGORIES, :prompt=> 'Select Category' %>
    </div>

    <div class="item_form_row">
      <label> Name<span>*</span>:</label>
      <%= f.text_field :name %>
    </div>

    <div class="item_form_row">
      <label> Logo:</label>
      <%= f.file_field :logo %>
    </div>


    <div class="item_form_row">
      <label>Description<span>*</span>:</label>
      <%= f.text_area :description, :rows => 20, :cols => 80 %>
    </div>


    <div class="item_form_row">
      <label>Company Website:</label>
      <%= f.text_field :web %>
    </div>


    <div class="item_form_row">
      <label> Destinations:</label>

      <div class="f_edit_row photo_box">
        <% for district in District.actives %>
            <div class="spot_in_package district_in_tour_operator">
              <%= check_box_tag "tour_operator[destination_ids][]", district.id, @tour_operator.destinations.include?(district), :id => dom_id(district) %>

              <label for="<%= dom_id(district) %>"><%= district.name %></label>
            </div>
        <% end %>
      </div>


    </div>
    <div class="item_form_row">
      <label> Spots:</label>

      <div class="f_edit_row photo_box">
        <% for spot in Spot.actives.includes(:district) %>
            <div class="spot_in_package spot_of_district_<%= spot.district_id %>">
              <%= check_box_tag "tour_operator[spot_ids][]", spot.id, @tour_operator.spots.include?(spot), :prev_checked => @tour_operator.spots.include?(spot), :id => dom_id(spot) %>

              <label for="<%= dom_id(spot) %>"><%= spot.name %></label>
            </div>
        <% end %>
      </div>
    </div>


    <div class="item_form_row">
      <label> Services:</label>

      <div class="f_edit_row photo_box" style="width:705px;">
        <div id="tour_operator_services" class="package_events">

          <% unless @tour_operator.new_record? %>
              <%= render :partial => 'service', :collection => @tour_operator.services, :locals => {:form => f} %>
          <% end %>
          <%= render :partial => 'service', :locals => {:form => f, :service => @tour_operator.services.new} if @tour_operator.new_record? || @tour_operator.services.size == 0 %>
        </div>

        <%= link_to '+Ad More', 'javascript:void(0)', :class=>'adMore addMoreService' %>
      </div>
    </div>



    <div class="item_form_row">
      <label> Policies:</label>

      <div class="f_edit_row photo_box" style="width:705px;">


        <div id="tour_operator_policies" class="package_events">

          <% unless @tour_operator.new_record? %>
              <%= render :partial => 'shared_partials/policy', :collection => @tour_operator.policies, :locals => {:form => f} %>
          <% end %>
          <%= render :partial => 'shared_partials/policy', :locals => {:form => f, :policy => @tour_operator.policies.new} if @tour_operator.new_record? || @tour_operator.policies.size == 0 %>
        </div>

        <%= link_to '+Ad More', 'javascript:void(0)', :class=>'adMore addMorePolicy' %>
      </div>

    </div>



    <div class="item_form_row">
      <label> Contacts:</label>

      <div class="f_edit_row photo_box" style="width:705px;">


        <div id="tour_operator_contacts" class="package_events">

          <% unless @tour_operator.new_record? %>
              <%= render :partial => 'shared_partials/contact', :collection => @tour_operator.contacts, :locals => {:form => f} %>
          <% end %>
          <%= render :partial => 'shared_partials/contact', :locals => {:form => f, :contact => @tour_operator.contacts.new} if @tour_operator.new_record? || @tour_operator.contacts.size == 0 %>
        </div>

        <%= link_to '+Ad More', 'javascript:void(0)', :class=>'adMore addMoreContact' %>
      </div>

    </div>


    <div class="submit_btn">
      <%= f.submit :class => 'search_button', :style => 'width:140px' %>
      <span class="search_button_right"> </span>
    </div>


<% end %>
<div style="display:none">
  <div id="new_contact_html">
    <%= render(:partial => 'shared_partials/contact', :locals => {:form => @builder}, :object => @tour_operator.contacts.new) %>
  </div>

  <div id="new_policy_html">
    <%= render(:partial => 'shared_partials/policy', :locals => {:form => @builder}, :object => @tour_operator.policies.new) %>
  </div>

<div id="new_service_html">
    <%= render(:partial => 'tour_operators/service', :locals => {:form => @builder}, :object => @tour_operator.services.new) %>
  </div>

  <%= render :partial => 'shared_partials/edit_asset_label' %>
</div>



<style type="text/css">


</style>
<script type="text/javascript">
    var allowed_images = 10;


    $.fn.checkUncheckSpot = function() {
        if (!$(this).attr('checked')) {
            $('.spot_of_district_' + $(this).attr('value')).children('input[type="checkbox"]').each(function() {
                $(this).removeAttr('checked');
            });
            $('.spot_of_district_' + $(this).attr('value')).hide();
        }
        else {
            $('.spot_of_district_' + $(this).attr('value')).show();
            $('.spot_of_district_' + $(this).attr('value')).children('input[type="checkbox"]').each(function() {
                if ($(this).attr('prev_checked') == 'true')
                    $(this).attr('checked', 'checked');
            });
        }

    }


    $.fn.handleDistrictSelection = function() {
        $(".district_in_tour_operator input[type='checkbox']").change(function () {
            $(this).checkUncheckSpot();
        });

    }


    $.fn.removePContact = function() {
        $(this).parents('.contact').remove();
    }

    $.fn.removePService = function() {
        $(this).parents('.service').remove();
    }

    $.fn.removePDepartureSchedule = function() {
        $(this).parents('.departure_schedule').remove();
    }

    $.fn.removePBranchLocation = function() {
        $(this).parents('.branch_location').remove();
    }

    $.fn.removePDestination = function() {
        $(this).parents('.destination').remove();
    }
    $.fn.removePPolicies = function() {
        $(this).parents('.policy').remove();
    }


    $(document).ready(function() {

        $('a.addMoreContact').click(function() {
            var new_object_id = new Date().getTime();
            var html = $($('#new_contact_html').html().replace(/index_to_replace_with_js/g, new_object_id)).hide();
            html.appendTo($('#tour_operator_contacts')).slideDown('slow');
            $('span.removeContactField').click(function() {
                $(this).removePContact();
            });

            $('span.removeContactField').click(function() {
                $(this).removePContact();
            });
        });

        $('span.removeContactField').click(function() {
            $(this).removePContact();
        });

        $('a.addMoreService').click(function() {
            var new_object_id = new Date().getTime();
            var html = $($('#new_service_html').html().replace(/index_to_replace_with_js/g, new_object_id)).hide();
            html.appendTo($('#tour_operator_services')).slideDown('slow');
            $('span.removeServiceField').click(function() {
                $(this).removePService();
            });

            $('span.removeServiceField').click(function() {
                $(this).removePService();
            });
        });

        $('span.removeServiceField').click(function() {
            $(this).removePService();
        });


        $('a.addMorePolicy').click(function() {
            var new_object_id = new Date().getTime();
            var html = $($('#new_policy_html').html().replace(/index_to_replace_with_js/g, new_object_id)).hide();
            html.appendTo($('#tour_operator_policies')).slideDown('slow');
            $('span.removePolicyField').click(function() {
                $(this).removePPolicy();
            });

            $('span.removePolicyField').click(function() {
                $(this).removePPolicy();
            });
        });

        $('span.removePolicyField').click(function() {
            $(this).removePPolicy();
        });


        $('span.removeImageField').click(function() {
            $(this).parents('.photo').remove();
        });


        $("#tour_operator_form").validate({
            errorPlacement: function(error, element) {
                error.remove();
            },


            rules: {
                'tour_operator[category_id]': "required",
                'tour_operator[title]' : "required",
                'tour_operator[price]': "required"
                //tour_operator_tour_operator_name: "required",
                //tour_operator_short_description: "required"

            },
            messages: {
                comment: "Please enter a comment."
            }
        });

        $('#tour_operator_discount_till, #tour_operator_start_date, #tour_operator_end_date').datepicker({
            changeMonth: true,
            changeYear: true
        });
        $(this).handleDistrictSelection();

        $(".district_in_tour_operator input[type='checkbox']").each(function () {
            $(this).checkUncheckSpot();
        });

    });


</script>
